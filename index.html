<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash cards</title>
    <style>
        a { display: block; }
        .selected { border: 2px solid green; }
        img { max-width: 200px; margin-left: 1px; }
    </style>
</head>
<body>
    <script>
        var
            use_english_categories = false,
            use_thumbnails = true,
            categories = ['Category:Mammals of Asia', 'Category:Member states of the European Union'],
            language = (window.navigator.userLanguage || window.navigator.language).substr(0, 2),
            uniqid = function () {
                return 'cb' + String(Math.random()).substring(2, 10);
            },
            cached = function (f) {
                var cache = {};
                return function () {
                    var i, arg, key = '', cb;
                    for (i = 0; i < arguments.length; i++) {
                        arg = arguments[i];
                        if (typeof arg === 'function') {
                            cb = arg;
                            arguments[i] = function () {
                                cache[key] = arguments;
                                cb.apply(this, arguments);
                            };
                        } else {
                            key += '/' + arg;
                        }
                    }
                    if (!cache.hasOwnProperty(key)) {
                        f.apply(this, arguments);
                    } else {
                        cb.apply(this, cache[key]);
                    }
                };
            },
            exec = cached(function (src, cb) {
                var
                    cbName = uniqid(),
                    script = document.createElement('script');

                window[cbName] = cb;
                script.src = src.replace('CBNAME', cbName);
                document.body.appendChild(script);
            }),
            translate = function (slugs, cur_lang, callback) {
                var
                    translate_url = "https://en.wikipedia.org/w/api.php?action=query&prop=langlinks&lllang=" + cur_lang + "&format=json&callback=CBNAME&titles=",
                    names = [];
                exec(translate_url + slugs.join('|'), function (data) {
                    var
                        page,
                        idx,
                        i;
                    for (i in data.query.pages) {
                        page = data.query.pages[i];
                        idx = slugs.indexOf(page.title);
                        names[idx] = typeof page.langlinks != 'undefined' ? page.langlinks[0]['*'] : page.title;
                    }
                    callback(names);
                });
            };

        function shuffle(a) {
            var j, x, i;
            for (i = a.length; i; i--) {
                j = Math.floor(Math.random() * i);
                x = a[i - 1];
                a[i - 1] = a[j];
                a[j] = x;
            }
        }
        function generate(number_of_words, cur_lang, category) {
            var
                selected,
                imgClick = function () {
                    if (!selected) {
                        selected = this;
                        this.className = 'selected';
                    } else if (selected != this && selected.dataset['word'] == this.dataset['word']) {
                        document.body.removeChild(selected);
                        document.body.removeChild(this);
                        selected = null;
                    } else {
                        selected.className = '';
                        selected = null;
                    }
                    return false;
                },
                imgLoaded = function (img) {
                    return function (data) {
                        var img = this;
                        pages = data.query.pages;
                        for (var i in pages) {
                            if (typeof pages[i].thumbnail !== 'undefined') {
                                img.src = pages[i].thumbnail.original || pages[i].thumbnail.source;
                            } else {
                                img.src = "http://placehold.it/" + (use_thumbnails ? '50x30' : '350x150') + "?text=" + img.dataset['word'];
                            }
                        }
                    }.bind(img)
                },
                loadImg = function (img, slug) {
                    var
                        piprop = use_thumbnails ? 'thumbnail' : 'original',
                        cat_lang = use_english_categories ? 'en' : cur_lang;
                    exec("https://" + cat_lang + ".wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&callback=CBNAME&piprop=" + piprop + "&titles=" + slug, imgLoaded(img));
                },
                takeRandom = function (number_of_words, callback) {
                    var
                        i,
                        slugs = [],
                        words_en = [],
                        cat_lang = use_english_categories ? 'en' : cur_lang,
                        category_url = "https://" + cat_lang + ".wikipedia.org/w/api.php?action=query&format=json&callback=CBNAME&list=categorymembers&cmtype=page&cmlimit=30&cmtitle=" + category,
                        indexes = [];
                    exec(category_url, function (data) {
                        var
                            i,
                            ar = data.query.categorymembers;
                        for (i = 0; i < ar.length; i++) {
                            words_en.push(ar[i].title);
                        }
                        for (i = 0; i < words_en.length; i++) {
                            indexes.push(i);
                        }
                        shuffle(indexes);
                        indexes = indexes.slice(0, number_of_words);
                        for (i = 0; i < indexes.length; i++) {
                            slugs.push(words_en[indexes[i]]);
                        }
                        if (use_english_categories) {
                            translate(slugs, cur_lang, function (names) {
                                callback(slugs, names);
                            });
                        } else {
                            callback(slugs, slugs);
                        }
                    });
                },
                showImages = function (slugs, names) {
                    var i, slug, img
                    for (var i = 0; i < slugs.length; i++) {
                        slug = slugs[i];
                        img = document.createElement('img');
                        img.onclick = imgClick;
                        img.dataset['word'] = names[i];
                        document.body.appendChild(img);
                        loadImg(img, slug);
                    }

                },
                showNames = function (names) {
                    var i, name, link;
                    for (i = 0; i < names.length; i++) {
                        name = names[i];
                        link = document.createElement('a');
                        link.href = '#';
                        link.text = name;
                        link.onclick = imgClick;
                        link.dataset['word'] = name;
                        document.body.appendChild(link);
                    }
                };
            takeRandom(number_of_words, function (slugs, names) {
                showImages(slugs, names);
                shuffle(names);
                showNames(names);
            });
            return false;
        }
        translate(categories, language, function (names) {
            var i, link;
            for (i = 0; i < names.length; i++) {
                link = document.createElement('a');
                link.href = '#';
                link.text = names[i];
                link.onclick = function () {
                    var i = this;
                    generate(5, language, use_english_categories ? categories[i] : names[i]);
                    return false;
                }.bind(i);
                document.body.appendChild(link);
            }
        });
    </script>
</body>
</html>
