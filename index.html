<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash cards</title>
    <style>
        a { display: block; }
        .selected { border: 2px solid green; }
        img { max-width: 200px; }
    </style>
</head>
<body>
    <a href="#" onclick="return generate(5)">Ещё</a><br/>
    <script>
        function shuffle(a) {
            var j, x, i;
            for (i = a.length; i; i--) {
                j = Math.floor(Math.random() * i);
                x = a[i - 1];
                a[i - 1] = a[j];
                a[j] = x;
            }
        }
        function generate(number_of_words) {
            var
                selected,
                imgClick = function () {
                    if (!selected) {
                        selected = this;
                        this.className = 'selected';
                    } else if (selected != this && selected.dataset['word'] == this.dataset['word']) {
                        document.body.removeChild(selected);
                        document.body.removeChild(this);
                        selected = null;
                    } else {
                        selected.className = '';
                        selected = null;
                    }
                    return false;
                },
                imgLoaded = function (img) {
                    return function (data) {
                        var img = this;
                        pages = data.query.pages;
                        for (var i in pages) {
                            if (typeof pages[i].thumbnail !== 'undefined') {
                                img.src = pages[i].thumbnail.original || pages[i].thumbnail.source;
                            } else {
                                img.src = "http://placehold.it/350x150?text=" + img.dataset['word'];
                            }
                        }
                    }.bind(img)
                },
                uniqid = function () {
                    return 'cb' + String(Math.random()).substring(2, 10);
                },
                exec = function (src, cb) {
                    var
                        cbName = uniqid(),
                        script = document.createElement('script');

                    window[cbName] = cb;
                    script.src = src.replace('CBNAME', cbName);
                    document.body.appendChild(script);
                },
                loadImg = function (img, slug) {
                    exec("https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&callback=CBNAME&piprop=original&titles=" + slug, imgLoaded(img));
                },
                takeRandom = function (number_of_words, callback) {
                    var
                        i,
                        slugs = [],
                        names = [],
                        words_en = [],
                        words_ru = [],
                        category_url = "https://en.wikipedia.org/w/api.php?action=query&format=json&callback=CBNAME&list=categorymembers&cmtype=page&cmlimit=30&cmtitle=Category:Mammals_of_Asia",
                        translate_url = "https://en.wikipedia.org/w/api.php?action=query&prop=langlinks&lllang=ru&format=json&callback=CBNAME&titles=",
                        indexes = [];
                    exec(category_url, function (data) {
                        var
                            i,
                            ar = data.query.categorymembers;
                        for (i = 0; i < ar.length; i++) {
                            words_en.push(ar[i].title);
                        }
                        for (i = 0; i < words_en.length; i++) {
                            indexes.push(i);
                        }
                        shuffle(indexes);
                        indexes = indexes.slice(0, number_of_words);
                        for (i = 0; i < indexes.length; i++) {
                            slugs.push(words_en[indexes[i]]);
                        }
                        exec(translate_url + slugs.join('|'), function (data) {
                            var
                                page,
                                idx,
                                i;
                            for (i in data.query.pages) {
                                page = data.query.pages[i];
                                idx = slugs.indexOf(page.title);
                                names[idx] = typeof page.langlinks != 'undefined' ? page.langlinks[0]['*'] : page.title;
                            }
                            callback(slugs, names);
                        });
                    });
                },
                showImages = function (slugs, names) {
                    var i, slug, img
                    for (var i = 0; i < slugs.length; i++) {
                        slug = slugs[i];
                        img = document.createElement('img');
                        img.onclick = imgClick;
                        img.dataset['word'] = names[i];
                        document.body.appendChild(img);
                        loadImg(img, slug);
                    }

                },
                showNames = function (names) {
                    var i, name, link;
                    for (i = 0; i < names.length; i++) {
                        name = names[i];
                        link = document.createElement('a');
                        link.href = '#';
                        link.text = name;
                        link.onclick = imgClick;
                        link.dataset['word'] = name;
                        document.body.appendChild(link);
                    }
                };
            takeRandom(number_of_words, function (slugs, names) {
                showImages(slugs, names);
                shuffle(names);
                showNames(names);
            });
            return false;
        }
        generate(5);
    </script>
</body>
</html>
